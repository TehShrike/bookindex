var Joi = require('joi')
var Promise = require('promise')
var knex = require('./db')

  // `upc` CHAR(12) DEFAULT NULL,
  // `isbn` CHAR(13) DEFAULT NULL,
  // `ean` CHAR(13) DEFAULT NULL,
  // `asin` CHAR(10) DEFAULT NULL,


var schema = Joi.object().keys({
	upc: Joi.string().max(12),
	isbn: Joi.string().max(13),
	ean: Joi.string().max(13),
	asin: Joi.string().max(10),
	title: Joi.string().max(500).required(),
	author: Joi.string().max(500),
	amazon_result: Joi.string().required(),
	last_amazon_update: Joi.date().default(function() { return new Date() }, 'current time')
}).or('upc', 'isbn', 'ean', 'asin')

var validateIsbn = Promise.denodeify(function validate(o, cb) {
	schema.validate(o, cb)
})

function insert(isbns) {
	if (!Array.isArray(isbns)) {
		return insert([ isbns ])
	}
	return Promise.all(isbns.map(function(isbn) {
		return validateIsbn(isbn)
	})).then(function(validatedIsbns) {
		return knex('barcode').insert(validatedIsbns)
	})
}

function loadByBarcode(barcodeAry) {
	console.log('looking up isbns in the database by', barcodeAry)
	return knex.select('id', 'upc', 'isbn', 'ean', 'asin', 'title', 'author', 'amazon_result')
		.from('barcode')
		.whereIn('isbn', barcodeAry)
		.orWhereIn('upc', barcodeAry)
		.orWhereIn('ean', barcodeAry)
		.orWhereIn('asin', barcodeAry)
}

function findIsbnsInDatabase(barcodeAry) {
	return loadByBarcode(barcodeAry).then(function(results) {
		return {
			found: results.map(function(row) {
				return row.amazon_result
			}),
			notFound: barcodeAry.filter(function notInQueryResult(isbn) {
				return results.every(function(row) {
					return [ row.upc, row.isbn, row.ean, row.asin ].indexOf(isbn) !== -1
				})
			})
		}
	})
}

module.exports = {
	loadByBarcode: loadByBarcode,
	insert: insert,
	findIsbnsInDatabase: findIsbnsInDatabase
}
